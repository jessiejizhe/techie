<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://jessiejizhe.github.io/techie/python/pyspark/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>pyspark - Techie</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Techie</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">CS61A</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../CS61A/ex-function/" class="dropdown-item">function</a>
</li>
                                    
<li>
    <a href="../../CS61A/ex-recursion/" class="dropdown-item">recursion</a>
</li>
                                    
<li>
    <a href="../../CS61A/ex-sequence/" class="dropdown-item">sequence</a>
</li>
                                    
<li>
    <a href="../../CS61A/ex-tree/" class="dropdown-item">tree</a>
</li>
                                    
<li>
    <a href="../../CS61A/ex-linked_list/" class="dropdown-item">linked_list</a>
</li>
                                    
<li>
    <a href="../../CS61A/1-intro/" class="dropdown-item">CS61A-intro</a>
</li>
                                    
<li>
    <a href="../../CS61A/2-function/" class="dropdown-item">CS61A-function</a>
</li>
                                    
<li>
    <a href="../../CS61A/3-data_abstraction/" class="dropdown-item">CS61A-data abstraction</a>
</li>
                                    
<li>
    <a href="../../CS61A/4-object_oriented/" class="dropdown-item">CS61A-object oriented</a>
</li>
                                    
<li>
    <a href="../../CS61A/5-computer_programs/" class="dropdown-item">CS61A-computer programs</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">DevOps</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../devops/git/" class="dropdown-item">git</a>
</li>
                                    
<li>
    <a href="../../devops/cron/" class="dropdown-item">cron</a>
</li>
                                    
<li>
    <a href="../../devops/unix/" class="dropdown-item">unix</a>
</li>
                                    
<li>
    <a href="../../devops/markdown/" class="dropdown-item">markdown</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Apache</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../Apache/Hadoop.md" class="dropdown-item">Hadoop</a>
</li>
                                    
<li>
    <a href="../../Apache/MapReduce/" class="dropdown-item">MapReduce</a>
</li>
                                    
<li>
    <a href="../../Apache/HDFS/" class="dropdown-item">HDFS</a>
</li>
                                    
<li>
    <a href="../../Apache/Spark/" class="dropdown-item">Spark</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Python</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../autogen/" class="dropdown-item">autogen</a>
</li>
                                    
<li>
    <a href="../basics/" class="dropdown-item">basics</a>
</li>
                                    
<li>
    <a href="../dataIO/" class="dropdown-item">dataIO</a>
</li>
                                    
<li>
    <a href="../datetime/" class="dropdown-item">datetime</a>
</li>
                                    
<li>
    <a href="../pandas/" class="dropdown-item">pandas</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">pyspark</a>
</li>
                                    
<li>
    <a href="../UDF/" class="dropdown-item">UDF</a>
</li>
                                    
<li>
    <a href="../ml/" class="dropdown-item">ml</a>
</li>
                                    
<li>
    <a href="../plot/" class="dropdown-item">plot</a>
</li>
                                    
<li>
    <a href="../iPython/" class="dropdown-item">iPython</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">SQL</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../sql/hive/" class="dropdown-item">hive</a>
</li>
                                    
<li>
    <a href="../../sql/presto/" class="dropdown-item">presto</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../pandas/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../UDF/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#libraries" class="nav-link">libraries</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#data-io" class="nav-link">data I/O</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#read-data" class="nav-link">read data</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#write-data" class="nav-link">write data</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#data-explore" class="nav-link">data explore</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#data-process" class="nav-link">data process</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#topandas" class="nav-link">toPandas</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#create-table" class="nav-link">create table</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#create-col" class="nav-link">create col</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#rename-col" class="nav-link">rename col</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#filters" class="nav-link">filters</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#change-data-type" class="nav-link">change data type</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#unique-value-to-list" class="nav-link">unique value to list</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#use-sql-syntax" class="nav-link">use SQL syntax</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#regular-expression" class="nav-link">regular expression</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#distinct" class="nav-link">distinct</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#substring" class="nav-link">substring</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#explode" class="nav-link">explode</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#extract" class="nav-link">extract</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#hashing" class="nav-link">hashing</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#column-intersection-with-list" class="nav-link">column intersection with list</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#table-transform" class="nav-link">table transform</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#join-tables" class="nav-link">join tables</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#pivot-table" class="nav-link">pivot table</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#cross-tabulation-contigency-table" class="nav-link">cross tabulation / contigency table</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#cumulative-percentages" class="nav-link">(cumulative) percentages</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#row-difference" class="nav-link">row difference</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#bucketizer" class="nav-link">bucketizer</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#stats" class="nav-link">stats</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#basic-statistics" class="nav-link">basic statistics</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#pearson-spearman-r-correlation-test" class="nav-link">pearson / spearman R correlation test</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#chi-square-test" class="nav-link">chi-square test</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#udfs-and-udafs" class="nav-link">UDFs and UDAFs</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="libraries">libraries</h1>
<pre><code class="language-python">from pyspark.sql import SparkSession, Row, Window
from pyspark.sql.types import *
import pyspark.sql.functions as F

from pyspark.mllib.stat import Statistics
from pyspark.mllib.linalg import Vectors
from pyspark.mllib.regression import LabeledPoint
from collections import OrderedDict

from datetime import datetime, timedelta
</code></pre>
<h1 id="data-io">data I/O</h1>
<h2 id="read-data">read data</h2>
<p>hive</p>
<pre><code class="language-python">sql_query = &quot;&quot;&quot;
    SELECT *
    FROM $db_name.tb_name
    WHERE datestamp = '%s'
    &quot;&quot;&quot;%(utc_hour)
df = spark.sql(sql_query)
</code></pre>
<p>avro</p>
<pre><code class="language-python">df = spark.read.format(&quot;com.databricks.spark.avro&quot;).load(file_path)
</code></pre>
<p>csv</p>
<pre><code class="language-python">file_path = '/user/test.csv'

df = spark.read.csv(file_path, header=True).drop('index')
df = spark.read.csv(file_path, header=True, sep='\t')
df = spark.read.format(&quot;com.databricks.spark.csv&quot;).option(&quot;delimiter&quot;, &quot;\t&quot;).option(&quot;header&quot;, &quot;true&quot;).load(file_path)
</code></pre>
<p>parquet</p>
<pre><code class="language-python">df = spark.read.orc()
</code></pre>
<p>orc</p>
<pre><code class="language-python">df = spark.read.orc()
</code></pre>
<p>bz2</p>
<pre><code class="language-python">df = spark.read.format('json').load()
</code></pre>
<p>create UDFs to read hourly and aggregate to daily</p>
<pre><code class="language-python">def read_snapshot_hourly(utc_hour):
    url = &quot;test.csv&quot;
    mapping = spark.read.csv(url, header=False).drop('index')
    mapping = mapping.withColumnRenamed('_c0','id').withColumnRenamed('_c1','cnt')
    mapping = mapping.select('id','cnt')
    mapping = mapping.withColumn('hour', lit(utc_hour))
    return mapping

def read_snapshot_daily(utc_date):
    field = [StructField(&quot;id&quot;,IntegerType(), True),
             StructField(&quot;cnt&quot;, StringType(), True),
             StructField(&quot;hour&quot;, StringType(), True)]
    schema = StructType(field)
    mapdf = sqlContext.createDataFrame(sc.emptyRDD(), schema)

    for i in range(0,24):
        j = str(i).zfill(2)
        utc_hour = utc_date + j
        mapping = read_snapshot_hourly(utc_hour)
        mapdf = mapdf.union(mapping)
    return mapdf
</code></pre>
<p>sc.parallelize(...) spread the data amongst all executors</p>
<p>sc.broadcast(...) copy the data in the jvm of each executor</p>
<h2 id="write-data">write data</h2>
<p>hive</p>
<pre><code class="language-python">res.write.format(&quot;orc&quot;).saveAsTable(&quot;$db_name.$table_name&quot;)
res.coalesce(10).write.partitionBy(&quot;dt&quot;, &quot;hour&quot;).saveAsTable(&quot;$db_name.$table_name&quot;, format = &quot;orc&quot;, mode = &quot;overwrite&quot;)
</code></pre>
<p>insert partitions into hive table</p>
<pre><code class="language-python">if tb_name not in sql_context.tableNames(db_name):
    res.write.partitionBy(&quot;datestamp&quot;).saveAsTable(&quot;%s.%s&quot;%(db_name, tb_name), format=&quot;orc&quot;, mode=&quot;append&quot;)
else:
    spark.conf.set(&quot;spark.sql.legacy.allowCreatingManagedTableUsingNonemptyLocation&quot;, &quot;true&quot;)
    spark.sql(&quot;ALTER TABLE %s.%s DROP IF EXISTS PARTITION (datestamp=%s)&quot;%(db_name, tb_name, utc_hour))
    res.write.partitionBy(&quot;datestamp&quot;).saveAsTable(&quot;%s.%s&quot;%(db_name, tb_name), format=&quot;orc&quot;, mode=&quot;append&quot;)
</code></pre>
<p>avro</p>
<pre><code class="language-python">res_path = &quot;/user/res/&quot; + mydate
res.write.format(&quot;com.databricks.spark.avro&quot;).save(res_path)
</code></pre>
<p>csv</p>
<pre><code class="language-python">res_path = '/user/res'
res.coalesce(1).write.csv(res_path, header=True)
</code></pre>
<h1 id="data-explore">data explore</h1>
<pre><code class="language-python">print df.printSchema()
print df.dtypes
print df.first()
print df.collect()
print df.limit(5).show()
print df.show(5)
print df.count()

df.columns
df.schema.names

cols = [i for i in df if i[:8]==date]
cols.append('line_id')
</code></pre>
<h1 id="data-process">data process</h1>
<h2 id="topandas">toPandas</h2>
<p>it is encouraged to use native PySpark against Pandas</p>
<pre><code class="language-python">dfpd = df.toPandas()
</code></pre>
<h2 id="create-table">create table</h2>
<p>create empty table</p>
<pre><code class="language-python">from pyspark.sql import SQLContext
sc = spark.sparkContext
sqlContext = SQLContext(sc)
# need the above for PySpark Shell

field = [StructField(&quot;id&quot;,StringType(), True),
         StructField(&quot;cnt&quot;, IntergerType(), True),
         StructField(&quot;hour&quot;, StringType(), True)]
schema = StructType(field)
mapdf = sqlContext.createDataFrame(sc.emptyRDD(), schema)
</code></pre>
<p>create random table</p>
<pre><code class="language-python">df = sqlContext.range(0, 10)
df = df.select(&quot;id&quot;, rand(seed=10).alias(&quot;uniform&quot;), randn(seed=27).alias(&quot;normal&quot;))
</code></pre>
<p>create from empty pandas dataframe</p>
<pre><code class="language-python">empty_dict = dict()
pd_empty = pd.DataFrame.from_dict(df_perf_dict, orient='index', columns=['score'])
empty_schema = StructType([StructField('score', DoubleType(), False)])
spark_empty = spark.createDataFrame(pd_empty, schema= empty_schema)
</code></pre>
<p>create dataframe from list</p>
<pre><code class="language-python">schema = StructType([StructField('id', StringType()), StructField('cnt', IntegerType())])
val = [[1, 13234121], [2, 233], [3, 13132]]
df = spark.createDataFrame(val, schema=schema)
</code></pre>
<h2 id="create-col">create col</h2>
<p>create new columns and assign values</p>
<pre><code class="language-python">df = df.na.fill('0')
df.na.fill({'age': 50, 'name': 'unknown'})

df = df.withColumn('if_null', F.when(df.id=='00000',-1)
                               .F.when(df.id=='',0)
                               .otherwise(1))
df = df.withColumn('click_label', F.when(df.click_label==-1,0)
                                           .otherwise(df.click_label)
                                           .alias('click_label'))
df = df.select(*(F.when((col(c))=='', None).otherwise(col(c)).alias(c) for c in df.columns))

df = df.withColumn('app_id',regexp_replace('app_id','APPIDC:',''))
df = df.withColumn('category', explode(split('category','APPC:')))
df = df.select(F.substring(df.label,6,100).alias('label'))
</code></pre>
<p>create empty column in dataframe</p>
<pre><code class="language-python">empty_schema = StructType([StructField('id', StringType(),True),
                           StructField('price', DoubleType(),True),
                           StructField('type', StringType(),True),
                           StructField('info_bag', ArrayType(StructType(
                               [StructField('seats', StringType(),True)]),True),True),
                           StructField('level',StringType(),True)])
df = df.withColumn('info_exp', lit(None).cast(empty_schema))
</code></pre>
<h2 id="rename-col">rename col</h2>
<pre><code class="language-python">for c,n in zip(df.columns, newcolnames):
    df = df.withColumnRenamed(c,n)
</code></pre>
<h2 id="filters">filters</h2>
<pre><code class="language-python">df = df.filter((df.type_id==2) | (df.type_id==3))
df = df.filter(F.col('id')==19)
df = df.filter(df.name.isNotNull()).filter(df.name !=&quot;&quot;)

df.filter(&quot;region='US' and name in ('John','Jane')&quot;).show()
</code></pre>
<h2 id="change-data-type">change data type</h2>
<pre><code class="language-python">df = df.withColumn('id', df.id.cast('integer'))

df_num = df_num.select(*(col(c).cast('integer') for c in df_num.columns))
df_num_rdd = df_num.rdd.map(lambda data: Vectors.dense([int(c) for c in data]))

OrderedDict(sorted(result_dic.items(), key=lambda t: t[1],reverse=True))
</code></pre>
<h2 id="unique-value-to-list">unique value to list</h2>
<pre><code class="language-python">browser_list = df.select('name').rdd.flatMap(lambda x: x).collect()
</code></pre>
<h2 id="use-sql-syntax">use SQL syntax</h2>
<pre><code class="language-python">df.registerTempTable(&quot;people&quot;)
a = sqlContext.sql(&quot;select * from people&quot;)
a.show()
</code></pre>
<h2 id="regular-expression">regular expression</h2>
<pre><code class="language-python">vista = vista.withColumn('v_version', F.when(vista.debug_metrics.like('%0.0.%'),1)\  
                                     .F.when(vista.debug_metrics.like('%2.0.%'),2)\  
                                     .otherwise(0))  
</code></pre>
<h2 id="distinct">distinct</h2>
<pre><code class="language-python">df.groupBy('click_label').count().show()

df.groupby('id_type').agg(countDistinct('id').alias('u_id')).orderBy('u_id').show()

df.select( [ countDistinct(cn).alias(cn) for cn in df.columns ] ).show()
df.select('user_id').distinct().show()
</code></pre>
<h2 id="substring">substring</h2>
<pre><code class="language-python">dd2 = [('device1','APPC:1'),
       ('device2','APPC:2'),
       ('device3','APPC:3')]  
test2 = spark.createDataFrame(dd2, ['id','label'])  
replace1 = test2.select(F.substring(test2.label,6,100).alias('label'))  
replace2 = test2.select(F.regexp_replace('label','APPC:','').alias('label'))  
</code></pre>
<h2 id="explode">explode</h2>
<pre><code class="language-python">dd3 = [('device1','APPC:lifeAPPC:sports'),
       ('device2','APPC:lifeAPPC:gameAPPC:sports'),
       ('device3','APPC:sports'),
       ('device4','nah')]  
test3 = spark.createDataFrame(dd3, ['id','group'])  
explode = test3.withColumn('group', F.explode(split('group','APPC:'))))  
explode = explode.filter(F.explode.group !=&quot;&quot;)  
</code></pre>
<h2 id="extract">extract</h2>
<pre><code class="language-python">dd4 = [('device1','APPIDC:1'),
       ('device2','APPIDC:2'),
       ('device3','APPIDC:3'),
       ('device4','')]  
test4 = spark.createDataFrame(dd4, ['id','group'])  
extract0 = test4.withColumn('group', F.when(test4.group=='', None).otherwise(test4.group))  
extract00 = extract0.na.fill('0')  
extract = extract00.withColumn('group', F.regexp_replace('group','APPIDC:',''))  
</code></pre>
<h2 id="hashing">hashing</h2>
<pre><code class="language-python">dd5 = [('device1','level1'),
       ('device2','level2'),
       ('device3','level1'),
       ('device4','')]
test5 = spark.createDataFrame(dd5, ['id','group'])
test5.select(F.hash('group')).show()
</code></pre>
<h2 id="column-intersection-with-list">column intersection with list</h2>
<pre><code class="language-python">dd6 = [('d1',[1,2,3]),
       ('d2',[1,2]),
       ('d3',[4]),
       ('d4',[3])]
test6 = spark.createDataFrame(dd6, ['id','labels'])
test_list = [2,3]
intersect_udf = lambda y: (F.udf(
                lambda x: (
                    list(set(x) &amp; set(y)) if x is not None and y is not None else None),
                ArrayType(IntegerType())))
intersect_with_bucket = intersect_udf(test_list)
test6 = test6.withColumn('intersect', intersect_with_bucket(test6.labels))
test6 = test6.withColumn('size', F.size(intersect_with_bucket(test6.labels)))
test6.show()
</code></pre>
<h1 id="table-transform">table transform</h1>
<h2 id="join-tables">join tables</h2>
<p>side by side</p>
<pre><code class="language-python">df_join = df1.join(df2, df1.source == df2.source, 'outer')
df_join = df1.join(df2, 'source', 'outer')

skewdf = bigdf.join(F.broadcast(smalldf), key)
</code></pre>
<p>stack</p>
<pre><code class="language-python">tablenew = table1.union(table2)
</code></pre>
<h2 id="pivot-table">pivot table</h2>
<pre><code class="language-python">df.groupBy('reason').pivot('id_type').agg(F.sum('cnt')).na.fill(0)
  .orderBy('reason').show(10)
</code></pre>
<h2 id="cross-tabulation-contigency-table">cross tabulation / contigency table</h2>
<pre><code class="language-python">names = [&quot;Alice&quot;, &quot;Bob&quot;, &quot;Mike&quot;]
items = [&quot;milk&quot;, &quot;bread&quot;, &quot;butter&quot;, &quot;apples&quot;, &quot;oranges&quot;]
df = sqlContext.createDataFrame([(names[i % 3], items[i % 5]) for i in range(100)], [&quot;name&quot;, &quot;item&quot;])
df.stat.crosstab(&quot;name&quot;, &quot;item&quot;).show()
</code></pre>
<h2 id="cumulative-percentages">(cumulative) percentages</h2>
<pre><code class="language-python">from pyspark.sql import Window

df = df.withColumn('total_req', F.sum('req_cnt').over(Window.partitionBy(key_col)))\
       .withColumn('req_p', F.round(100*F.col('req_cnt')/F.col('total_req'),1))

windowval = (Window.partitionBy('bucket').orderBy('fallout_bucket')
             .rangeBetween(Window.unboundedPreceding, 0))
df = df.withColumn('cum_load', F.sum('load').over(windowval).cast('integer'))
df = df.withColumn('adj_cum_load',F.round(df.cum_load/df.traffic_p,0).cast('integer'))

</code></pre>
<h2 id="row-difference">row difference</h2>
<pre><code class="language-python">my_window = Window.partitionBy().orderBy('time')

# get value from the previous row
df = df.withColumn('prev_value', F.lead(df.value).over(my_window))
df = df.withColumn('diff', F.when(F.isnull(df.value - df.prev_value), 0).otherwise(df.value - df.prev_value))

# get value from the following row
df = df.withColumn('prev_value', F.lag(df.value).over(my_window))
df = df.withColumn('diff', F.when(F.isnull(df.value - df.prev_value), 0).otherwise(df.value - df.prev_value))
</code></pre>
<h2 id="bucketizer">bucketizer</h2>
<pre><code class="language-python">from pyspark.ml.feature import Bucketizer

splits = [-float(&quot;inf&quot;), -0.5, 0.0, 0.5, float(&quot;inf&quot;)]

data = [(-999.9,), (-0.5,), (-0.3,), (0.0,), (0.2,), (999.9,)]
df = spark.createDataFrame(data, [&quot;features&quot;])

bucketizer = Bucketizer(splits=splits, inputCol=&quot;features&quot;, outputCol=&quot;bucketedFeatures&quot;)

print splits
print df.show()

# Transform original data into its bucket index.
bucketedData = bucketizer.transform(df)

print(&quot;Bucketizer output with %d buckets&quot; % (len(bucketizer.getSplits())-1))
bucketedData.show()
</code></pre>
<h1 id="stats">stats</h1>
<h2 id="basic-statistics">basic statistics</h2>
<pre><code class="language-python">df.groupBy().agg(F.min('value'),F.avg('value'),F.max('value')).show()
</code></pre>
<h2 id="pearson-spearman-r-correlation-test">pearson / spearman R correlation test</h2>
<pre><code class="language-python">df = df.select(*(col(c).cast('float') for c in df.columns))
df_rdd = df.rdd.map(lambda data: Vectors.dense([c for c in data]))

result_matrix = Statistics.corr(df_rdd, method=&quot;pearson&quot;)
result_matrix = Statistics.corr(df_rdd, method=&quot;spearman&quot;)

result_dic = dict(zip(df_num.columns, result_matrix[0].tolist()))
result_num = pd.DataFrame({'column': result_dic.keys(), 'corr': result_dic.values()})
</code></pre>
<h2 id="chi-square-test">chi-square test</h2>
<pre><code class="language-python">df = df.na.fill('nah')
df = df.select(*(hash(col(c)).cast('integer') for c in df.columns))
df_rdd = df.rdd.map(lambda data: Vectors.dense([c for c in data]))
df_rdd = df_rdd.map(lambda row: LabeledPoint(row[0],row[1:]))

obs = sc.parallelize(
    [LabeledPoint(1.0, [1.0,3.0]),
     LabeledPoint(1.0, [1.0,0.0]),
     LabeledPoint(1.0, [-1.0,-0.5])]
)

featureTestResults = Statistics.chiSqTest(obs)

for i, result in enumerate(featureTestResults_all_1):
    print(&quot;Click correlation with %s:\n%s\n&quot; % (df_rdd.columns[i+1], result))

res = []
for i, result in enumerate(featureTestResults):
    row = []
    row.append(i)
    row.append(result.degreesOfFreedom)
    row.append(result.pValue)
    row.append(result.statistic)
    res.append(row)
res = pd.DataFrame(res,columns=['col','dof','p','chi-sq'])
res
</code></pre>
<h1 id="udfs-and-udafs">UDFs and UDAFs</h1>
<pre><code class="language-python">def convert_big_num_smart(num):
    if num &gt;= 1e9:
        big_num = str(round(num / 1e9, 1)) + 'B'
    elif num &gt;= 1e6:
        big_num = str(round(num / 1e6, 1)) + 'M'
    elif num &gt;= 1e3:
        big_num = str(round(num / 1e3, 1)) + 'K'
    else:
        big_num = str(round(num, 1))
    return big_num

convertBigNumSmartUDF = F.udf(convert_big_num_smart, StringType())
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
